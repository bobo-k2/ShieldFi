<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ShieldFi Dashboard</title>
<style>
  * { margin: 0; padding: 0; box-sizing: border-box; }
  body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; background: #0a0a0a; color: #e0e0e0; min-height: 100vh; }
  .container { max-width: 960px; margin: 0 auto; padding: 2rem 1.5rem; }
  .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem; flex-wrap: wrap; gap: 1rem; }
  .logo { font-size: 1.5rem; font-weight: 700; background: linear-gradient(135deg, #00d4aa, #7b61ff); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
  .header-right { display: flex; align-items: center; gap: 0.75rem; }
  .wallet-addr { font-family: monospace; font-size: 0.85rem; color: #888; background: #151520; padding: 6px 12px; border-radius: 6px; }
  .btn { padding: 10px 20px; background: linear-gradient(135deg, #00d4aa, #7b61ff); color: #000; font-weight: 600; border: none; border-radius: 8px; cursor: pointer; font-size: 0.9rem; transition: opacity 0.2s; }
  .btn:hover { opacity: 0.85; }
  .btn:disabled { opacity: 0.5; cursor: not-allowed; }
  .btn-revoke { background: #ff4444; color: #fff; padding: 6px 14px; font-size: 0.8rem; border-radius: 6px; }
  .btn-revoke:hover { background: #ff2222; }
  .btn-outline { background: transparent; border: 1px solid #00d4aa; color: #00d4aa; }

  .cards { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin-bottom: 2rem; }
  .card { background: #111118; border: 1px solid #1a1a2e; border-radius: 12px; padding: 1.25rem; }
  .card-label { font-size: 0.8rem; color: #666; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 0.5rem; }
  .card-value { font-size: 2rem; font-weight: 700; }
  .score-good { color: #00d4aa; }
  .score-warn { color: #ffaa00; }
  .score-bad { color: #ff4444; }

  table { width: 100%; border-collapse: collapse; }
  th { padding: 10px 12px; text-align: left; color: #555; font-size: 0.8rem; text-transform: uppercase; letter-spacing: 0.5px; border-bottom: 1px solid #1a1a2e; }
  td { padding: 12px; border-bottom: 1px solid #0f0f1a; }
  .addr { font-family: monospace; font-size: 0.85rem; color: #aaa; }
  .badge { display: inline-block; padding: 3px 10px; border-radius: 20px; font-size: 0.75rem; font-weight: 600; }
  .badge-LOW { background: #00d4aa20; color: #00d4aa; }
  .badge-MEDIUM { background: #ffaa0020; color: #ffaa00; }
  .badge-HIGH { background: #ff664420; color: #ff6644; }
  .badge-CRITICAL { background: #ff004420; color: #ff0044; }

  .empty-state { text-align: center; padding: 4rem 2rem; color: #555; }
  .empty-state .icon { font-size: 3rem; margin-bottom: 1rem; }
  .empty-state p { font-size: 1.1rem; }

  .loading { text-align: center; padding: 3rem; color: #555; }
  .spinner { display: inline-block; width: 24px; height: 24px; border: 3px solid #333; border-top-color: #00d4aa; border-radius: 50%; animation: spin 0.8s linear infinite; margin-right: 8px; vertical-align: middle; }
  @keyframes spin { to { transform: rotate(360deg); } }

  .error-msg { background: #ff444420; border: 1px solid #ff444444; color: #ff6666; padding: 12px 16px; border-radius: 8px; margin-bottom: 1rem; }
  .section-title { font-size: 1rem; color: #888; margin-bottom: 1rem; text-transform: uppercase; letter-spacing: 0.5px; }
</style>
</head>
<body>
<div class="container">
  <div class="header">
    <a href="/" style="text-decoration:none"><span class="logo">üõ°Ô∏è ShieldFi</span></a>
    <div class="header-right">
      <span class="wallet-addr" id="walletDisplay" style="display:none"></span>
      <button class="btn" id="connectBtn" onclick="connect()">Connect Wallet</button>
      <button class="btn btn-outline" id="scanBtn" onclick="scan()" style="display:none">üîç Scan</button>
    </div>
  </div>

  <div id="error" style="display:none" class="error-msg"></div>
  <div id="cards" class="cards" style="display:none">
    <div class="card">
      <div class="card-label">Wallet Health</div>
      <div class="card-value" id="healthScore">‚Äî</div>
    </div>
    <div class="card">
      <div class="card-label">Active Approvals</div>
      <div class="card-value" id="approvalCount">0</div>
    </div>
    <div class="card">
      <div class="card-label">Highest Risk</div>
      <div class="card-value" id="highestRisk">‚Äî</div>
    </div>
  </div>

  <div style="margin-bottom:2rem; padding:1.25rem; background:#111118; border:1px solid #1a1a2e; border-radius:12px;">
    <div class="card-label" style="margin-bottom:0.75rem">üîç Scan Any Wallet</div>
    <div style="display:flex; gap:0.5rem;">
      <input id="lookupAddr" type="text" placeholder="Paste any Solana address‚Ä¶" 
        style="flex:1; padding:10px 14px; background:#0a0a0a; border:1px solid #2a2a3e; border-radius:8px; color:#e0e0e0; font-family:monospace; font-size:0.9rem; outline:none;"
        onfocus="this.style.borderColor='#00d4aa'" onblur="this.style.borderColor='#2a2a3e'">
      <button class="btn" onclick="lookupWallet()">Scan</button>
    </div>
  </div>

  <div id="monitorSection" style="display:none; margin-bottom:2rem; padding:1.25rem; background:#111118; border:1px solid #1a1a2e; border-radius:12px;">
    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:0.75rem;">
      <div class="card-label">üîî Real-Time Monitoring</div>
      <span id="monitorStatus" style="font-size:0.8rem;"></span>
    </div>
    <button class="btn" id="monitorBtn" onclick="toggleMonitor()" style="width:100%">üîî Start Monitoring</button>
    <div id="monitorAlerts" style="margin-top:1rem;"></div>
  </div>

  <div id="riskAnalysis" style="display:none; margin-bottom:2rem; padding:1.25rem; background:#111118; border:1px solid #1a1a2e; border-radius:12px;">
    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:0.75rem;">
      <div class="card-label">ü§ñ AI Risk Analysis</div>
      <span id="riskAnalysisStatus" style="font-size:0.8rem; color:#555;"></span>
    </div>
    <button class="btn" id="riskAnalysisBtn" onclick="runRiskAnalysis()" style="width:100%">üî¨ Run Deep Analysis</button>
    <div id="riskSummary" style="display:none; margin-top:1rem; padding:1rem; background:#0a0a0a; border:1px solid #1a1a2e; border-radius:8px;">
      <div id="riskSummaryText" style="font-size:0.95rem; line-height:1.6;"></div>
    </div>
    <div id="tokenReports" style="margin-top:1rem;"></div>
  </div>

  <div id="content">
    <div class="empty-state">
      <div class="icon">üîå</div>
      <p>Connect your Phantom wallet or paste any address above to scan</p>
    </div>
  </div>
</div>

<script>
let jwt = localStorage.getItem('shieldfi_jwt');
let walletAddr = localStorage.getItem('shieldfi_wallet');
const $ = (id) => document.getElementById(id);

function short(a) { return a.slice(0,4) + '‚Ä¶' + a.slice(-4); }

function showError(msg) {
  $('error').textContent = msg;
  $('error').style.display = 'block';
  setTimeout(() => $('error').style.display = 'none', 5000);
}

function setScore(riskScore) {
  const el = $('healthScore');
  const health = 100 - riskScore; // Flip: 100 = safe, 0 = dangerous
  el.textContent = health + '/100';
  el.className = 'card-value ' + (health >= 75 ? 'score-good' : health >= 40 ? 'score-warn' : 'score-bad');
}

// Base58 encoder
function toBase58(bytes) {
  const A = '123456789ABCDEFGHJKLMNPQRSTUVWXYZabcdefghijkmnopqrstuvwxyz';
  let n = 0n;
  for (const b of bytes) n = n * 256n + BigInt(b);
  let r = '';
  while (n > 0n) { r = A[Number(n % 58n)] + r; n /= 58n; }
  for (const b of bytes) { if (b !== 0) break; r = '1' + r; }
  return r;
}

async function api(path, opts = {}) {
  const headers = { 'Content-Type': 'application/json', ...(opts.headers || {}) };
  if (jwt) headers['Authorization'] = 'Bearer ' + jwt;
  const res = await fetch(path, { ...opts, headers });
  if (!res.ok) {
    const err = await res.json().catch(() => ({ error: res.statusText }));
    throw new Error(err.error || 'Request failed');
  }
  return res.json();
}

function getProvider() {
  const p = window.phantom?.solana || window.solana;
  if (!p?.isPhantom) { showError('Phantom wallet not found. Please install it from phantom.app'); return null; }
  return p;
}

async function connect() {
  const provider = getProvider();
  if (!provider) return;

  try {
    $('connectBtn').disabled = true;
    $('connectBtn').textContent = 'Connecting‚Ä¶';

    const resp = await provider.connect();
    walletAddr = resp.publicKey.toString();

    // Auth flow
    const { nonce } = await api('/api/auth/nonce', {
      method: 'POST', body: JSON.stringify({ wallet: walletAddr }),
    });

    const message = `Sign in to ShieldFi: ${nonce}`;
    const encoded = new TextEncoder().encode(message);
    const { signature } = await provider.signMessage(encoded, 'utf8');
    const sig58 = toBase58(signature);

    const { token } = await api('/api/auth/verify', {
      method: 'POST', body: JSON.stringify({ wallet: walletAddr, signature: sig58, nonce }),
    });

    jwt = token;
    localStorage.setItem('shieldfi_jwt', jwt);
    localStorage.setItem('shieldfi_wallet', walletAddr);

    // Add wallet
    await api('/api/wallets', { method: 'POST', body: JSON.stringify({ address: walletAddr }) });

    showConnected();
    scan();
  } catch (e) {
    console.error(e);
    showError(e.message || 'Connection failed');
    $('connectBtn').disabled = false;
    $('connectBtn').textContent = 'Connect Wallet';
  }
}

function showConnected() {
  $('walletDisplay').textContent = short(walletAddr);
  $('walletDisplay').style.display = 'inline-block';
  $('connectBtn').textContent = '‚úì Connected';
  $('connectBtn').disabled = true;
  $('scanBtn').style.display = 'inline-block';
  $('cards').style.display = 'grid';
}

async function scan() {
  $('scanBtn').disabled = true;
  $('scanBtn').textContent = '‚è≥ Scanning‚Ä¶';
  $('content').innerHTML = '<div class="loading"><span class="spinner"></span> Scanning on-chain approvals‚Ä¶</div>';

  try {
    const data = await api('/api/approvals/scan', { method: 'POST', body: '{}' });
    renderApprovals(data.approvals || [], data.walletScore || 0);
  } catch (e) {
    showError('Scan failed: ' + e.message);
    $('content').innerHTML = '<div class="empty-state"><div class="icon">‚ö†Ô∏è</div><p>Scan failed. Try again.</p></div>';
  } finally {
    $('scanBtn').disabled = false;
    $('scanBtn').textContent = 'üîç Scan';
  }
}

async function loadApprovals() {
  try {
    const data = await api('/api/approvals');
    renderApprovals(data.approvals || [], data.walletScore || 0);
  } catch (e) {
    showError(e.message);
  }
}

function renderApprovals(approvals, score) {
  setScore(score);
  $('approvalCount').textContent = approvals.length;

  if (!approvals.length) {
    $('highestRisk').textContent = '‚Äî';
    $('highestRisk').className = 'card-value score-good';
    $('content').innerHTML = `
      <div class="empty-state">
        <div class="icon">‚úÖ</div>
        <p>No active approvals found. Your wallet looks clean!</p>
      </div>`;
    return;
  }

  const riskOrder = { CRITICAL: 4, HIGH: 3, MEDIUM: 2, LOW: 1 };
  const worst = approvals.reduce((a, b) => (riskOrder[b.riskLevel] || 0) > (riskOrder[a.riskLevel] || 0) ? b : a);
  const hrEl = $('highestRisk');
  hrEl.innerHTML = `<span class="badge badge-${worst.riskLevel}">${worst.riskLevel}</span>`;

  let html = '<div class="section-title">Active Approvals</div><table><thead><tr><th>Token</th><th>Spender</th><th>Amount</th><th>Risk</th><th>Action</th></tr></thead><tbody>';
  for (const a of approvals) {
    const tokenLabel = a.tokenSymbol || short(a.tokenMint);
    html += `<tr>
      <td>${a.tokenIcon ? `<img src="${a.tokenIcon}" width="16" height="16" style="border-radius:50%;vertical-align:middle;margin-right:6px" onerror="this.style.display='none'">` : ''}${tokenLabel}</td>
      <td class="addr">${short(a.spender)}</td>
      <td>${a.isUnlimited ? '<span style="color:#ff6644">‚ôæÔ∏è Unlimited</span>' : a.amount}</td>
      <td><span class="badge badge-${a.riskLevel}">${a.riskLevel}</span></td>
      <td><button class="btn btn-revoke" onclick="revoke('${a.id}')">Revoke</button></td>
    </tr>`;
  }
  html += '</tbody></table>';
  $('content').innerHTML = html;
}

async function revoke(id) {
  const provider = getProvider();
  if (!provider) return;

  try {
    const data = await api(`/api/approvals/${id}/revoke`, { method: 'POST' });
    // Deserialize and sign
    const { Transaction } = await import('https://esm.sh/@solana/web3.js@1.95.0');
    const txBuf = Uint8Array.from(atob(data.transaction), c => c.charCodeAt(0));
    const tx = Transaction.from(txBuf);
    const signed = await provider.signTransaction(tx);
    
    // Send via connection
    const { Connection } = await import('https://esm.sh/@solana/web3.js@1.95.0');
    const conn = new Connection('https://api.mainnet-beta.solana.com', 'confirmed');
    const sig = await conn.sendRawTransaction(signed.serialize());
    alert('Revoke submitted! TX: ' + sig);
    scan();
  } catch (e) {
    console.error(e);
    showError('Revoke failed: ' + e.message);
  }
}

async function lookupWallet() {
  const addr = $('lookupAddr').value.trim();
  if (!addr) return showError('Paste a Solana address first');

  $('cards').style.display = 'grid';
  $('content').innerHTML = '<div class="loading"><span class="spinner"></span> Scanning on-chain data‚Ä¶</div>';

  try {
    const res = await fetch(`/api/approvals/lookup?address=${encodeURIComponent(addr)}`);
    if (!res.ok) { const e = await res.json(); throw new Error(e.error || 'Lookup failed'); }
    const data = await res.json();
    renderLookup(data);
  } catch (e) {
    showError(e.message);
    $('content').innerHTML = '<div class="empty-state"><div class="icon">‚ö†Ô∏è</div><p>Lookup failed. Check the address.</p></div>';
  }
}

function renderLookup(data) {
  setScore(data.walletScore);
  $('approvalCount').textContent = data.approvals.length;

  let html = '';

  // Token balances ‚Äî grouped by status
  if (data.balances && data.balances.length > 0) {
    const verified = data.balances.filter(b => b.status === 'verified');
    const unknown = data.balances.filter(b => b.status === 'unknown');
    const suspicious = data.balances.filter(b => b.status === 'suspicious');
    const totalUsd = verified.reduce((s, b) => s + (b.usdValue || 0), 0);

    function renderBalanceTable(tokens, showUsd) {
      let t = '<table><thead><tr><th>Token</th><th style="text-align:right">Balance</th>';
      if (showUsd) t += '<th style="text-align:right">USD Value</th>';
      t += '</tr></thead><tbody>';
      for (const b of tokens) {
        const fmtBal = typeof b.balance === 'number' ? b.balance.toLocaleString(undefined, {minimumFractionDigits: 0, maximumFractionDigits: 4}) : b.balance;
        const fmtUsd = b.usdValue != null ? `$${b.usdValue.toFixed(2)}` : '<span style="color:#444">‚Äî</span>';
        const flagTip = b.flags && b.flags.length ? ` title="${b.flags.join(', ')}"` : '';
        t += `<tr${flagTip}>
          <td>${b.icon ? `<img src="${b.icon}" width="20" height="20" style="border-radius:50%;vertical-align:middle;margin-right:8px" onerror="this.style.display='none'">` : '<span style="display:inline-block;width:20px;height:20px;margin-right:8px"></span>'}${b.symbol}</td>
          <td style="text-align:right;font-family:monospace;color:#ccc">${fmtBal}</td>`;
        if (showUsd) t += `<td style="text-align:right;font-family:monospace;${b.usdValue > 0 ? 'color:#00d4aa' : ''}">${fmtUsd}</td>`;
        t += '</tr>';
      }
      t += '</tbody></table>';
      return t;
    }

    if (verified.length > 0) {
      html += `<div class="section-title">‚úÖ Verified Tokens ‚Äî Total: $${totalUsd.toFixed(2)}</div>`;
      html += renderBalanceTable(verified, true) + '<br>';
    }

    if (unknown.length > 0) {
      html += `<div class="section-title">‚ùì Unknown Tokens (${unknown.length})</div>`;
      html += renderBalanceTable(unknown, false) + '<br>';
    }

    if (suspicious.length > 0) {
      html += `<div class="section-title" style="color:#ff6644">‚ö†Ô∏è Suspicious Tokens (${suspicious.length}) ‚Äî likely spam airdrops</div>`;
      html += '<div style="font-size:0.8rem;color:#666;margin-bottom:0.5rem">These tokens may be scam airdrops. Do not interact with them.</div>';
      html += renderBalanceTable(suspicious, false) + '<br>';
    }
  }

  // Approvals
  if (data.approvals.length > 0) {
    const riskOrder = { CRITICAL: 4, HIGH: 3, MEDIUM: 2, LOW: 1 };
    const worst = data.approvals.reduce((a, b) => (riskOrder[b.riskLevel] || 0) > (riskOrder[a.riskLevel] || 0) ? b : a);
    $('highestRisk').innerHTML = `<span class="badge badge-${worst.riskLevel}">${worst.riskLevel}</span>`;

    html += '<div class="section-title">Active Approvals</div><table><thead><tr><th>Token</th><th>Spender</th><th>Amount</th><th>Risk</th></tr></thead><tbody>';
    for (const a of data.approvals) {
      html += `<tr>
        <td>${a.tokenIcon ? `<img src="${a.tokenIcon}" width="16" height="16" style="border-radius:50%;vertical-align:middle;margin-right:6px" onerror="this.style.display='none'">` : ''}${a.tokenSymbol || short(a.tokenMint)}</td>
        <td class="addr">${short(a.spender)}</td>
        <td>${a.isUnlimited ? '<span style="color:#ff6644">‚ôæÔ∏è Unlimited</span>' : a.amount}</td>
        <td><span class="badge badge-${a.riskLevel}">${a.riskLevel}</span></td>
      </tr>`;
    }
    html += '</tbody></table>';
  } else {
    $('highestRisk').textContent = '‚Äî';
    $('highestRisk').className = 'card-value score-good';
    html += `<div class="empty-state"><div class="icon">‚úÖ</div><p>No active approvals found. This wallet looks clean!</p></div>`;
  }

  if (!data.balances?.length && !data.approvals.length) {
    html = `<div class="empty-state"><div class="icon">üì≠</div><p>No tokens or approvals found. Wallet may be empty.</p></div>`;
  }

  $('content').innerHTML = html;

  // Auto-load transactions
  const txAddr = $('lookupAddr').value.trim();
  if (txAddr) loadTransactions(txAddr);
}

const TX_TYPE_COLORS = {
  SWAP: '#7b61ff', TRANSFER: '#00d4aa', NFT_SALE: '#ff6644', NFT_MINT: '#ffaa00',
  NFT_LISTING: '#ff8844', BURN: '#ff4444', STAKE: '#44aaff', UNSTAKE: '#4488ff',
  COMPRESSED_NFT_MINT: '#ffaa00', TOKEN_MINT: '#44ddaa', UNKNOWN: '#555',
};

async function loadTransactions(addr) {
  const container = document.createElement('div');
  container.id = 'txSection';
  container.innerHTML = '<div class="section-title" style="margin-top:1.5rem">üìú Recent Activity</div><div class="loading"><span class="spinner"></span> Loading transactions‚Ä¶</div>';
  $('content').appendChild(container);

  try {
    const res = await fetch(`/api/transactions/${encodeURIComponent(addr)}?limit=20`);
    if (!res.ok) throw new Error('Failed');
    const data = await res.json();
    const txs = data.transactions || [];

    if (!txs.length) {
      container.innerHTML = '<div class="section-title" style="margin-top:1.5rem">üìú Recent Activity</div><div style="color:#555;text-align:center;padding:1rem;">No recent transactions found.</div>';
      return;
    }

    let html = '<div class="section-title" style="margin-top:1.5rem">üìú Recent Activity</div>';
    for (const tx of txs) {
      const type = tx.type || 'UNKNOWN';
      const color = TX_TYPE_COLORS[type] || TX_TYPE_COLORS.UNKNOWN;
      const time = tx.timestamp ? new Date(tx.timestamp * 1000).toLocaleString() : '‚Äî';
      const desc = tx.description || 'No description';
      const sig = tx.signature || '';

      // Token transfers summary
      let transfers = '';
      if (tx.tokenTransfers && tx.tokenTransfers.length > 0) {
        const parts = tx.tokenTransfers.slice(0, 3).map(t => {
          const amt = t.tokenAmount != null ? parseFloat(t.tokenAmount).toLocaleString(undefined, {maximumFractionDigits:4}) : '?';
          const sym = t.mint ? t.mint.slice(0,4) + '‚Ä¶' : '';
          return `<span style="color:#ccc;font-family:monospace;font-size:0.8rem">${amt} ${sym}</span>`;
        });
        transfers = parts.join(' ¬∑ ');
      }
      if (tx.nativeTransfers && tx.nativeTransfers.length > 0 && !transfers) {
        const total = tx.nativeTransfers.reduce((s, t) => s + Math.abs(t.amount || 0), 0) / 1e9;
        if (total > 0) transfers = `<span style="color:#ccc;font-family:monospace;font-size:0.8rem">${total.toLocaleString(undefined,{maximumFractionDigits:4})} SOL</span>`;
      }

      html += `<div style="padding:0.75rem;background:#111118;border:1px solid #1a1a2e;border-left:3px solid ${color};border-radius:6px;margin-bottom:0.5rem;">
        <div style="display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:0.5rem;">
          <div><span class="badge" style="background:${color}22;color:${color}">${type}</span> <span style="font-size:0.85rem;color:#aaa;margin-left:6px;">${desc.length > 100 ? desc.slice(0,100)+'‚Ä¶' : desc}</span></div>
          <span style="font-size:0.75rem;color:#555;">${time}</span>
        </div>
        ${transfers ? `<div style="margin-top:4px;">${transfers}</div>` : ''}
        ${sig ? `<a href="https://solscan.io/tx/${sig}" target="_blank" style="font-size:0.78rem;color:#7b61ff;">View on Solscan ‚Üí</a>` : ''}
      </div>`;
    }
    container.innerHTML = html;
  } catch {
    container.innerHTML = '<div class="section-title" style="margin-top:1.5rem">üìú Recent Activity</div><div style="color:#555;text-align:center;padding:1rem;">Failed to load transactions.</div>';
  }
}

// --- Monitoring ---
let currentLookupAddr = null;

const origLookupWallet = lookupWallet;
lookupWallet = async function() {
  const addr = $('lookupAddr').value.trim();
  currentLookupAddr = addr;
  lastLookupAddr = addr;
  await origLookupWallet();
  if (addr) {
    $('monitorSection').style.display = 'block';
    $('riskAnalysis').style.display = 'block';
    checkMonitorStatus(addr);
  }
};

async function checkMonitorStatus(addr) {
  try {
    const res = await fetch(`/api/monitor/${encodeURIComponent(addr)}/status`);
    const data = await res.json();
    if (data.isMonitored) {
      $('monitorBtn').textContent = 'üî¥ Stop Monitoring';
      $('monitorBtn').onclick = () => stopMonitor(addr);
      $('monitorStatus').innerHTML = '<span style="color:#00d4aa">üü¢ Active</span>' + (data.lastCheckedAt ? ' ‚Äî last check: ' + new Date(data.lastCheckedAt).toLocaleTimeString() : '');
      loadMonitorAlerts(addr);
    } else {
      $('monitorBtn').textContent = 'üîî Start Monitoring';
      $('monitorBtn').onclick = () => startMonitor(addr);
      $('monitorStatus').textContent = '';
      $('monitorAlerts').innerHTML = '';
    }
  } catch { /* ignore */ }
}

async function startMonitor(addr) {
  try {
    $('monitorBtn').disabled = true;
    const res = await fetch('/api/monitor/add', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ address: addr }),
    });
    if (!res.ok) throw new Error('Failed');
    checkMonitorStatus(addr);
  } catch (e) {
    showError('Failed to start monitoring: ' + e.message);
  } finally {
    $('monitorBtn').disabled = false;
  }
}

async function stopMonitor(addr) {
  try {
    $('monitorBtn').disabled = true;
    await fetch(`/api/monitor/${encodeURIComponent(addr)}`, { method: 'DELETE' });
    checkMonitorStatus(addr);
  } catch (e) {
    showError('Failed to stop monitoring: ' + e.message);
  } finally {
    $('monitorBtn').disabled = false;
  }
}

async function loadMonitorAlerts(addr) {
  try {
    const res = await fetch(`/api/monitor/${encodeURIComponent(addr)}/alerts`);
    const data = await res.json();
    const alerts = data.alerts || [];
    if (!alerts.length) {
      $('monitorAlerts').innerHTML = '<div style="color:#555; font-size:0.85rem; text-align:center; padding:0.5rem;">No alerts yet ‚Äî monitoring active</div>';
      return;
    }
    let html = '<div class="section-title" style="margin-top:0.5rem;">Recent Alerts</div>';
    for (const a of alerts.slice(0, 10)) {
      const sevColor = a.severity === 'CRITICAL' ? '#ff0044' : a.severity === 'WARNING' ? '#ffaa00' : '#00d4aa';
      const emoji = a.severity === 'CRITICAL' ? 'üö®' : a.severity === 'WARNING' ? '‚ö†Ô∏è' : '‚ÑπÔ∏è';
      html += `<div style="padding:0.75rem; background:#0a0a0a; border:1px solid #1a1a2e; border-left:3px solid ${sevColor}; border-radius:6px; margin-bottom:0.5rem;">
        <div style="display:flex; justify-content:space-between; align-items:center;">
          <span>${emoji} <strong style="color:${sevColor}">${a.severity}</strong> ‚Äî ${a.title}</span>
          <span style="font-size:0.75rem; color:#555;">${new Date(a.createdAt).toLocaleString()}</span>
        </div>
        <div style="font-size:0.85rem; color:#aaa; margin-top:4px;">${a.message}</div>
        ${a.txSignature ? `<a href="https://solscan.io/tx/${a.txSignature}" target="_blank" style="font-size:0.8rem; color:#7b61ff;">View on Solscan ‚Üí</a>` : ''}
      </div>`;
    }
    $('monitorAlerts').innerHTML = html;
  } catch { /* ignore */ }
}

function toggleMonitor() {
  if (currentLookupAddr) startMonitor(currentLookupAddr);
}

// --- Risk Analysis ---
let lastLookupAddr = null;

async function runRiskAnalysis() {
  const addr = lastLookupAddr || $('lookupAddr').value.trim();
  if (!addr) return showError('No wallet address to analyze');

  const btn = $('riskAnalysisBtn');
  btn.disabled = true;
  btn.textContent = '‚è≥ Analyzing tokens & contracts‚Ä¶';
  $('riskAnalysisStatus').textContent = 'This may take 10-20 seconds‚Ä¶';
  $('riskSummary').style.display = 'none';
  $('tokenReports').innerHTML = '';

  try {
    const res = await fetch(`/api/risk/wallet?address=${encodeURIComponent(addr)}`);
    if (!res.ok) { const e = await res.json(); throw new Error(e.error || 'Analysis failed'); }
    const data = await res.json();
    renderRiskAnalysis(data);
  } catch (e) {
    showError('Risk analysis failed: ' + e.message);
  } finally {
    btn.disabled = false;
    btn.textContent = 'üî¨ Run Deep Analysis';
    $('riskAnalysisStatus').textContent = '';
  }
}

function renderRiskAnalysis(data) {
  // Summary
  const summaryEl = $('riskSummary');
  summaryEl.style.display = 'block';
  const levelColors = { SAFE: '#00d4aa', LOW: '#00d4aa', MEDIUM: '#ffaa00', HIGH: '#ff6644', CRITICAL: '#ff0044' };
  const levelEmoji = { SAFE: '‚úÖ', LOW: 'üü¢', MEDIUM: 'üü°', HIGH: 'üü†', CRITICAL: 'üî¥' };
  const color = levelColors[data.level] || '#888';

  $('riskSummaryText').innerHTML = `
    <div style="display:flex; align-items:center; gap:0.75rem; margin-bottom:0.75rem;">
      <span style="font-size:1.8rem;">${levelEmoji[data.level] || '‚ùì'}</span>
      <div>
        <div style="font-size:1.2rem; font-weight:700; color:${color};">Risk Level: ${data.level}</div>
        <div style="font-size:0.85rem; color:#888;">Score: ${data.overallScore}/100 (lower is safer)</div>
      </div>
    </div>
    <div style="color:#ccc; font-size:0.9rem;">${data.summary}</div>
  `;

  // Token reports
  const reports = data.tokenReports || [];
  if (reports.length === 0) {
    $('tokenReports').innerHTML = '<div style="color:#555; text-align:center; padding:1rem;">No unknown/suspicious tokens to analyze.</div>';
    return;
  }

  let html = '<div class="section-title" style="margin-top:1rem;">Token Risk Reports</div>';
  for (const r of reports) {
    const c = levelColors[r.level] || '#888';
    const flagsHtml = r.flags.map(f => {
      const sevColor = f.severity === 'danger' ? '#ff4444' : f.severity === 'warning' ? '#ffaa00' : '#555';
      const sevIcon = f.severity === 'danger' ? 'üî¥' : f.severity === 'warning' ? 'üü°' : '‚ÑπÔ∏è';
      return `<div style="display:flex; align-items:center; gap:0.5rem; padding:4px 0; font-size:0.85rem;">
        <span>${sevIcon}</span>
        <span style="color:#aaa;">${f.signal}</span>
        <span style="color:${sevColor}; font-size:0.75rem; margin-left:auto;">${f.category}</span>
      </div>`;
    }).join('');

    const mintShort = r.mint.slice(0, 8) + '‚Ä¶' + r.mint.slice(-4);
    html += `<div style="padding:1rem; background:#0a0a0a; border:1px solid #1a1a2e; border-left:3px solid ${c}; border-radius:8px; margin-bottom:0.5rem;">
      <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:0.5rem;">
        <span style="font-weight:600; color:#e0e0e0;">${r.symbol || mintShort}</span>
        <span class="badge" style="background:${c}20; color:${c};">${r.level} (${r.overallScore})</span>
      </div>
      <div style="font-family:monospace; font-size:0.75rem; color:#555; margin-bottom:0.5rem;">
        <a href="https://solscan.io/token/${r.mint}" target="_blank" style="color:#7b61ff;">${mintShort}</a>
      </div>
      ${r.metadata?.mintAuthority ? '<div style="font-size:0.8rem; color:#ff6644; margin-bottom:4px;">‚ö†Ô∏è Mint authority: ' + r.metadata.mintAuthority.slice(0,8) + '‚Ä¶</div>' : ''}
      ${r.metadata?.freezeAuthority ? '<div style="font-size:0.8rem; color:#ffaa00; margin-bottom:4px;">‚ùÑÔ∏è Freeze authority: ' + r.metadata.freezeAuthority.slice(0,8) + '‚Ä¶</div>' : ''}
      ${flagsHtml}
    </div>`;
  }

  // Approval/spender risks
  const spenderRisks = data.approvalRisks || [];
  if (spenderRisks.length > 0) {
    html += '<div class="section-title" style="margin-top:1.5rem;">Spender Analysis</div>';
    for (const s of spenderRisks) {
      const sColor = s.isKnown ? '#00d4aa' : s.riskScore > 20 ? '#ff6644' : '#ffaa00';
      html += `<div style="padding:0.75rem; background:#0a0a0a; border:1px solid #1a1a2e; border-left:3px solid ${sColor}; border-radius:8px; margin-bottom:0.5rem;">
        <div style="display:flex; justify-content:space-between; align-items:center;">
          <span style="font-family:monospace; font-size:0.85rem; color:#aaa;">
            <a href="https://solscan.io/account/${s.spender}" target="_blank" style="color:#7b61ff;">${s.spender.slice(0,8)}‚Ä¶${s.spender.slice(-4)}</a>
          </span>
          <span style="font-size:0.85rem; color:${sColor};">${s.isKnown ? '‚úÖ Known DeFi' : s.label || 'Unknown'}</span>
        </div>
        ${s.flags.map(f => `<div style="font-size:0.8rem; color:#888; margin-top:4px;">${f.severity === 'danger' ? 'üî¥' : 'üü°'} ${f.signal}</div>`).join('')}
      </div>`;
    }
  }

  $('tokenReports').innerHTML = html;
}

// Auto-restore session ‚Äî silently clear if JWT is expired
if (jwt && walletAddr) {
  // Test if JWT is still valid before showing connected state
  fetch('/api/approvals', { headers: { 'Authorization': 'Bearer ' + jwt } })
    .then(r => {
      if (r.ok) { showConnected(); loadApprovals(); }
      else { localStorage.removeItem('shieldfi_jwt'); localStorage.removeItem('shieldfi_wallet'); jwt = null; walletAddr = null; }
    })
    .catch(() => { localStorage.removeItem('shieldfi_jwt'); localStorage.removeItem('shieldfi_wallet'); jwt = null; walletAddr = null; });
}
</script>
</body>
</html>
