<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ShieldFi Dashboard</title>
<style>
  *{margin:0;padding:0;box-sizing:border-box}
  html{scroll-behavior:smooth}
  body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif;background:#0a0a0a;color:#e0e0e0;min-height:100vh;line-height:1.6}

  /* Grid bg */
  body::before{content:'';position:fixed;inset:0;background-image:linear-gradient(rgba(255,255,255,.015) 1px,transparent 1px),linear-gradient(90deg,rgba(255,255,255,.015) 1px,transparent 1px);background-size:64px 64px;pointer-events:none;z-index:0}

  /* Nav */
  .topnav{position:sticky;top:0;z-index:100;padding:.75rem 2rem;display:flex;justify-content:space-between;align-items:center;background:rgba(10,10,10,.9);backdrop-filter:blur(12px);border-bottom:1px solid rgba(255,255,255,.04)}
  .nav-logo{font-size:1.15rem;font-weight:700;text-decoration:none;background:linear-gradient(135deg,#00d4aa,#7b61ff);-webkit-background-clip:text;-webkit-text-fill-color:transparent}
  .nav-right{display:flex;align-items:center;gap:.75rem}
  .wallet-pill{font-family:monospace;font-size:.8rem;color:#888;background:#111118;border:1px solid #1a1a2e;padding:6px 12px;border-radius:20px;cursor:pointer;transition:border-color .2s}
  .wallet-pill:hover{border-color:#00d4aa}

  .container{position:relative;z-index:1;max-width:960px;margin:0 auto;padding:1.5rem}

  /* Buttons */
  .btn{padding:10px 20px;background:linear-gradient(135deg,#00d4aa,#7b61ff);color:#000;font-weight:600;border:none;border-radius:8px;cursor:pointer;font-size:.9rem;transition:opacity .2s,transform .15s,box-shadow .2s;display:inline-flex;align-items:center;gap:.4rem}
  .btn:hover{opacity:.88;transform:translateY(-1px);box-shadow:0 4px 16px rgba(0,212,170,.2)}
  .btn:disabled{opacity:.4;cursor:not-allowed;transform:none;box-shadow:none}
  .btn-revoke{background:#ff4444;color:#fff;padding:6px 14px;font-size:.8rem;border-radius:6px}
  .btn-revoke:hover{background:#ff2222;box-shadow:0 2px 10px rgba(255,68,68,.3)}
  .btn-outline{background:transparent;border:1px solid #00d4aa;color:#00d4aa}
  .btn-outline:hover{background:rgba(0,212,170,.08)}
  .btn-sm{padding:8px 16px;font-size:.85rem}

  /* Scan input - prominent */
  .scan-section{margin-bottom:2rem;padding:1.5rem;background:#111118;border:1px solid #1a1a2e;border-radius:14px}
  .scan-section .label{font-size:.85rem;color:#888;text-transform:uppercase;letter-spacing:.5px;margin-bottom:.75rem;display:flex;align-items:center;gap:.5rem}
  .scan-row{display:flex;gap:.5rem}
  .scan-input{flex:1;padding:14px 18px;background:#0a0a0a;border:1px solid #2a2a3e;border-radius:10px;color:#e0e0e0;font-family:monospace;font-size:.95rem;outline:none;transition:border-color .2s,box-shadow .2s}
  .scan-input:focus{border-color:#00d4aa;box-shadow:0 0 0 3px rgba(0,212,170,.08)}
  .scan-input::placeholder{color:#3a3a4e}

  /* Cards */
  .stat-cards{display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:1rem;margin-bottom:2rem}
  .stat-card{background:#111118;border:1px solid #1a1a2e;border-radius:12px;padding:1.25rem;transition:border-color .2s}
  .stat-card:hover{border-color:rgba(0,212,170,.2)}
  .stat-label{font-size:.75rem;color:#555;text-transform:uppercase;letter-spacing:.5px;margin-bottom:.5rem}
  .stat-value{font-size:1.75rem;font-weight:700}
  .score-good{color:#00d4aa}
  .score-warn{color:#ffaa00}
  .score-bad{color:#ff4444}

  /* SOL hero card */
  .sol-hero{background:linear-gradient(135deg,rgba(0,212,170,.08),rgba(123,97,255,.08));border:1px solid rgba(0,212,170,.15);border-radius:14px;padding:2rem;text-align:center;margin-bottom:2rem}
  .sol-hero .amount{font-size:2.5rem;font-weight:800}
  .sol-hero .usd{font-size:1.1rem;color:#888;margin-top:.25rem}
  .sol-hero .label{font-size:.8rem;color:#555;text-transform:uppercase;letter-spacing:.5px;margin-bottom:.5rem}

  /* Section */
  .section{margin-bottom:2rem;animation:fadeUp .4s ease both}
  .section-title{font-size:.85rem;color:#666;text-transform:uppercase;letter-spacing:.5px;margin-bottom:1rem;display:flex;align-items:center;gap:.5rem}
  .section-title .caret{margin-left:auto;background:#1a1a2e;border:1px solid #252540;border-radius:6px;padding:4px 8px;transition:all .2s;display:inline-flex;align-items:center}
  .section-title .caret svg{width:14px;height:14px;stroke:#555;transition:transform .2s}
  .section-title:hover .caret{border-color:#7b61ff40}
  .section-title:hover .caret svg{stroke:#7b61ff}
  .section-title .caret.collapsed svg{transform:rotate(-90deg)}
  .section-card{background:#111118;border:1px solid #1a1a2e;border-radius:14px;padding:1.5rem}

  /* Token grid */
  .token-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(280px,1fr));gap:.75rem}
  .token-item{display:flex;align-items:center;gap:.75rem;padding:.75rem 1rem;background:#0a0a0a;border:1px solid #151520;border-radius:10px;transition:border-color .2s}
  .token-item:hover{border-color:rgba(0,212,170,.2)}
  .token-icon{width:36px;height:36px;border-radius:50%;background:#1a1a2e;display:flex;align-items:center;justify-content:center;font-size:.8rem;color:#555;overflow:hidden;flex-shrink:0}
  .token-icon img{width:100%;height:100%;object-fit:cover}
  .token-info{flex:1;min-width:0}
  .token-symbol{font-weight:600;font-size:.9rem}
  .token-balance{font-family:monospace;font-size:.85rem;color:#aaa}
  .token-usd{font-family:monospace;font-size:.85rem;color:#00d4aa;text-align:right;white-space:nowrap}

  /* Approval cards */
  .approval-card{padding:1rem;background:#0a0a0a;border:1px solid #151520;border-radius:10px;margin-bottom:.5rem;transition:border-color .2s}
  .approval-card:hover{border-color:rgba(255,100,68,.2)}
  .approval-header{display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:.5rem}
  .approval-detail{display:flex;gap:1.5rem;margin-top:.5rem;font-size:.8rem;color:#666;flex-wrap:wrap}

  /* Badge */
  .badge{display:inline-block;padding:3px 10px;border-radius:20px;font-size:.75rem;font-weight:600}
  .badge-LOW{background:rgba(0,212,170,.1);color:#00d4aa}
  .badge-MEDIUM{background:rgba(255,170,0,.1);color:#ffaa00}
  .badge-HIGH{background:rgba(255,100,68,.1);color:#ff6644}
  .badge-CRITICAL{background:rgba(255,0,68,.1);color:#ff0044}

  /* Timeline tx */
  .tx-item{padding:.75rem 1rem;background:#0a0a0a;border:1px solid #151520;border-left:3px solid #555;border-radius:8px;margin-bottom:.5rem;transition:border-color .2s}
  .tx-item:hover{border-color:rgba(123,97,255,.3)}
  .tx-header{display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:.5rem}
  .tx-desc{font-size:.85rem;color:#aaa;margin-top:4px}
  .tx-transfers{font-family:monospace;font-size:.8rem;color:#ccc;margin-top:4px}
  .tx-link{font-size:.78rem;color:#7b61ff;text-decoration:none;margin-top:4px;display:inline-block}
  .tx-link:hover{text-decoration:underline}
  .tx-time{font-size:.75rem;color:#444}

  /* Loading skeleton */
  .skeleton{background:linear-gradient(90deg,#111118 25%,#1a1a2e 50%,#111118 75%);background-size:200% 100%;animation:shimmer 1.5s infinite;border-radius:8px;height:20px;margin-bottom:.5rem}
  .skeleton.h-lg{height:48px;border-radius:12px;margin-bottom:1rem}
  .skeleton.h-card{height:120px;border-radius:14px}
  @keyframes shimmer{0%{background-position:200% 0}100%{background-position:-200% 0}}

  /* Spinner */
  .spinner{display:inline-block;width:20px;height:20px;border:2px solid #333;border-top-color:#00d4aa;border-radius:50%;animation:spin .7s linear infinite;vertical-align:middle}
  @keyframes spin{to{transform:rotate(360deg)}}

  /* Toast */
  .toast-container{position:fixed;top:5rem;right:1.5rem;z-index:200;display:flex;flex-direction:column;gap:.5rem;pointer-events:none}
  .toast{padding:.75rem 1.25rem;border-radius:10px;font-size:.85rem;pointer-events:auto;animation:toastIn .3s ease;max-width:360px;backdrop-filter:blur(8px)}
  .toast-success{background:rgba(0,212,170,.15);border:1px solid rgba(0,212,170,.3);color:#00d4aa}
  .toast-error{background:rgba(255,68,68,.15);border:1px solid rgba(255,68,68,.3);color:#ff6666}
  .toast-info{background:rgba(123,97,255,.15);border:1px solid rgba(123,97,255,.3);color:#b4a0ff}
  @keyframes toastIn{from{opacity:0;transform:translateX(20px)}to{opacity:1;transform:translateX(0)}}
  @keyframes toastOut{from{opacity:1}to{opacity:0;transform:translateX(20px)}}

  /* Empty state */
  .empty-state{text-align:center;padding:4rem 2rem;color:#444}
  .empty-state .empty-icon{font-size:3.5rem;margin-bottom:1rem;opacity:.6}
  .empty-state p{font-size:1rem;max-width:400px;margin:0 auto}

  /* Error */
  .error-bar{position:fixed;top:4rem;left:50%;transform:translateX(-50%);background:rgba(255,68,68,.12);border:1px solid rgba(255,68,68,.3);color:#ff6666;padding:10px 24px;border-radius:10px;z-index:150;font-size:.85rem;backdrop-filter:blur(8px);animation:toastIn .3s ease}

  /* Copyable */
  .copyable{cursor:pointer;position:relative}
  .copyable:hover{color:#00d4aa}
  .copy-tip{position:absolute;top:-28px;left:50%;transform:translateX(-50%);background:#00d4aa;color:#000;font-size:.7rem;padding:2px 8px;border-radius:4px;white-space:nowrap;opacity:0;pointer-events:none;transition:opacity .2s}
  .copyable:hover .copy-tip{opacity:1}

  /* Fade animation */
  @keyframes fadeUp{from{opacity:0;transform:translateY(16px)}to{opacity:1;transform:translateY(0)}}

  /* Responsive */
  @media(max-width:640px){
    .topnav{padding:.5rem .75rem;flex-wrap:wrap;gap:.5rem}
    .nav-right{gap:.5rem;flex-wrap:wrap;justify-content:flex-end}
    .nav-right .btn-sm{padding:6px 12px;font-size:.75rem}
    .wallet-pill{font-size:.7rem;padding:4px 8px;max-width:120px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
    .container{padding:.75rem}
    .scan-section{padding:1rem;margin-bottom:1rem}
    .scan-row{flex-direction:column}
    .stat-cards{grid-template-columns:1fr;gap:.5rem;margin-bottom:1rem}
    .stat-card{padding:.75rem 1rem;display:flex;align-items:center;justify-content:space-between}
    .stat-card .stat-label{margin-bottom:0;font-size:.7rem}
    .stat-card .stat-value{font-size:1.2rem;text-align:right}
    .token-grid{grid-template-columns:1fr}
    .token-item{padding:.6rem .75rem}
    .sol-hero .amount{font-size:1.8rem}
    .sol-hero{padding:1rem}
    .section-card{padding:1rem}
    .section-title{font-size:.75rem}
    .approval-header{flex-direction:column;align-items:flex-start}
    .tx-item{padding:.75rem}
    .btn{padding:8px 14px;font-size:.8rem}
    .toast{max-width:280px;font-size:.8rem}
  }
</style>
</head>
<body>

<nav class="topnav">
  <a href="/" class="nav-logo">üõ°Ô∏è ShieldFi</a>
  <div class="nav-right">
    <span class="wallet-pill" id="walletDisplay" style="display:none" onclick="copyAddr(this.dataset.full)" title="Click to copy"></span>
    <button class="btn btn-sm" id="connectBtn" onclick="connect()">Connect Wallet</button>
    <button class="btn btn-sm" id="disconnectBtn" onclick="disconnect()" style="display:none;background:#ff4444">Disconnect</button>
    <button class="btn btn-sm btn-outline" id="scanBtn" onclick="scan()" style="display:none">üîç Scan</button>
  </div>
</nav>

<div class="toast-container" id="toasts"></div>

<div class="container">

  <!-- Scan Section -->
  <div class="scan-section">
    <div class="label">üîç Scan Any Wallet</div>
    <div class="scan-row">
      <input class="scan-input" id="lookupAddr" type="text" placeholder="Paste any Solana address‚Ä¶" autocomplete="off">
      <button class="btn" id="lookupBtn" onclick="lookupWallet()">Scan</button>
    </div>
  </div>

  <!-- Stat Cards -->
  <div class="stat-cards" id="cards" style="display:none">
    <div class="stat-card" style="cursor:pointer" onclick="document.getElementById('riskAnalysis')?.scrollIntoView({behavior:'smooth',block:'start'})"><div class="stat-label">Risk Level</div><div class="stat-value" id="riskLevel">‚Äî</div></div>
    <div class="stat-card" style="cursor:pointer" onclick="document.getElementById('sectionVerified')?.scrollIntoView({behavior:'smooth',block:'start'})"><div class="stat-label">Total Tokens</div><div class="stat-value" id="tokenCount">‚Äî</div></div>
    <div class="stat-card" style="cursor:pointer" onclick="document.getElementById('sectionSuspicious')?.scrollIntoView({behavior:'smooth',block:'start'})"><div class="stat-label">Suspicious</div><div class="stat-value" id="suspiciousCount">‚Äî</div></div>
  </div>

  <!-- Monitor Section (hidden initially) ‚Äî TOP FEATURE -->
  <div id="monitorSection" style="display:none" class="section">
    <div class="section-card">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:.75rem;flex-wrap:wrap;gap:.5rem">
        <div class="section-title" style="margin:0">üîî Real-Time Monitoring</div>
        <span id="monitorStatus" style="font-size:.8rem"></span>
      </div>
      <button class="btn" id="monitorBtn" onclick="toggleMonitor()" style="width:100%">üîî Start Monitoring</button>
      <div id="telegramLink" style="display:none;margin-top:1rem;padding:1rem;background:#0a0a0a;border:1px solid #1a1a2e;border-radius:10px">
        <div style="display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:.5rem">
          <span id="telegramStatus" style="font-size:.85rem"></span>
          <button class="btn btn-sm" id="telegramBtn" onclick="linkTelegram()">üì± Connect Telegram</button>
        </div>
      </div>
      <div id="monitorAlerts" style="margin-top:1rem"></div>
    </div>
  </div>

  <!-- Risk Analysis (hidden initially) ‚Äî TOP FEATURE -->
  <div id="riskAnalysis" style="display:none" class="section">
    <div class="section-card">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:.75rem;flex-wrap:wrap;gap:.5rem">
        <div class="section-title" style="margin:0">ü§ñ AI Risk Analysis</div>
        <span id="riskAnalysisStatus" style="font-size:.8rem;color:#555"></span>
      </div>
      <button class="btn" id="riskAnalysisBtn" onclick="runRiskAnalysis()" style="width:100%">üî¨ Run Deep Analysis</button>
      <div id="riskSummary" style="display:none;margin-top:1rem;padding:1rem;background:#0a0a0a;border:1px solid #1a1a2e;border-radius:10px">
        <div id="riskSummaryText"></div>
      </div>
      <div id="tokenReports" style="margin-top:1rem"></div>
    </div>
  </div>

  <!-- Results (balances, approvals, transactions) -->
  <div id="content">
    <div class="empty-state">
      <div class="empty-icon">üîå</div>
      <p>Connect your Phantom wallet or paste any Solana address above to scan</p>
    </div>
  </div>

</div>

<script>
let jwt = localStorage.getItem('shieldfi_jwt');
let walletAddr = localStorage.getItem('shieldfi_wallet');
const $ = id => document.getElementById(id);

/* ---- Helpers ---- */
function short(a){return a?a.slice(0,4)+'‚Ä¶'+a.slice(-4):''}

function fmt(n,dec=2){
  if(n==null||isNaN(n))return '‚Äî';
  const num=Number(n);
  if(Math.abs(num)<0.0001&&num!==0)return num.toExponential(2);
  return num.toLocaleString(undefined,{minimumFractionDigits:0,maximumFractionDigits:dec});
}

function fmtUsd(n){
  if(n==null||isNaN(n))return '‚Äî';
  return '$'+Number(n).toLocaleString(undefined,{minimumFractionDigits:2,maximumFractionDigits:2});
}

/* Toast system */
function toast(msg,type='info'){
  const el=document.createElement('div');
  el.className='toast toast-'+type;
  el.textContent=msg;
  $('toasts').appendChild(el);
  setTimeout(()=>{el.style.animation='toastOut .3s ease forwards';setTimeout(()=>el.remove(),300)},3500);
}

function showError(msg){toast(msg,'error')}

/* Copy */
function copyAddr(text){
  navigator.clipboard.writeText(text).then(()=>toast('Copied!','success')).catch(()=>{});
}
function copyable(addr){
  return `<span class="copyable" onclick="copyAddr('${addr}')" title="Click to copy"><span class="copy-tip">Copy</span>${short(addr)}</span>`;
}

/* Skeleton loading */
const CHEVRON_SVG='<svg viewBox="0 0 24 24" fill="none" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><polyline points="6 9 12 15 18 9"></polyline></svg>';
function toggleCollapse(el){const body=el.nextElementSibling;const caret=el.querySelector('.caret');if(body.style.display==='none'){body.style.display='block';caret.classList.remove('collapsed')}else{body.style.display='none';caret.classList.add('collapsed')}}
function collapsibleTitle(title,extra=''){return `<div class="section-title" style="cursor:pointer;user-select:none" onclick="toggleCollapse(this)">${title}${extra} <span class="caret collapsed">${CHEVRON_SVG}</span></div><div style="display:none">`}

function showSkeleton(){
  $('cards').style.display='grid';
  $('riskLevel').textContent='‚è≥';$('tokenCount').textContent='‚Ä¶';$('suspiciousCount').textContent='‚Ä¶';
  $('content').innerHTML=`
    <div class="skeleton h-card" style="margin-bottom:1.5rem"></div>
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:.75rem;margin-bottom:1.5rem">
      <div class="skeleton" style="height:80px;border-radius:10px"></div>
      <div class="skeleton" style="height:80px;border-radius:10px"></div>
      <div class="skeleton" style="height:80px;border-radius:10px"></div>
      <div class="skeleton" style="height:80px;border-radius:10px"></div>
    </div>
    <div class="skeleton" style="height:60px;border-radius:10px;margin-bottom:.5rem"></div>
    <div class="skeleton" style="height:60px;border-radius:10px;margin-bottom:.5rem"></div>
    <div class="skeleton" style="height:60px;border-radius:10px"></div>`;
}

function setRiskLevel(level){
  const el=$('riskLevel');
  const colors={SAFE:'#00d4aa',LOW:'#00d4aa',MEDIUM:'#ffa726',HIGH:'#ff6644',CRITICAL:'#ff2244'};
  const c=colors[level]||'#888';
  el.innerHTML=`<span style="color:${c};font-weight:700">${level||'‚Äî'}</span>`;
}
function setTokenStats(balances){
  const verified=(balances||[]).filter(b=>b.status==='verified').length;
  const unknown=(balances||[]).filter(b=>b.status==='unknown').length;
  const suspicious=(balances||[]).filter(b=>b.status==='suspicious').length;
  const total=balances?balances.length:0;
  $('tokenCount').innerHTML=total?`${total}<div style="font-size:.6rem;color:#888;margin-top:2px;line-height:1.3"><span style="color:#00d4aa">${verified}‚úì</span> ¬∑ <span style="color:#888">${unknown}?</span> ¬∑ <span style="color:#ff6644">${suspicious}‚ö†</span></div>`:'‚Äî';
  const el=$('suspiciousCount');
  el.textContent=suspicious.toString();
  el.className='stat-value '+(suspicious===0?'score-good':suspicious<=2?'score-warn':'score-bad');
}

/* Base58 */
function toBase58(bytes){
  const A='123456789ABCDEFGHJKLMNPQRSTUVWXYZabcdefghijkmnopqrstuvwxyz';
  let n=0n;for(const b of bytes)n=n*256n+BigInt(b);
  let r='';while(n>0n){r=A[Number(n%58n)]+r;n/=58n}
  for(const b of bytes){if(b!==0)break;r='1'+r}
  return r;
}

async function api(path,opts={}){
  const headers={'Content-Type':'application/json',...(opts.headers||{})};
  if(jwt)headers['Authorization']='Bearer '+jwt;
  const res=await fetch(path,{...opts,headers});
  if(!res.ok){const err=await res.json().catch(()=>({error:res.statusText}));throw new Error(err.error||'Request failed')}
  return res.json();
}

function getProvider(){
  const p=window.phantom?.solana||window.solana;
  if(!p?.isPhantom){showError('Phantom wallet not found. Install from phantom.app');return null}
  return p;
}

async function connect(){
  const provider=getProvider();if(!provider)return;
  try{
    $('connectBtn').disabled=true;$('connectBtn').textContent='Connecting‚Ä¶';
    const resp=await provider.connect();
    walletAddr=resp.publicKey.toString();
    const{nonce}=await api('/api/auth/nonce',{method:'POST',body:JSON.stringify({wallet:walletAddr})});
    const message=`Sign in to ShieldFi: ${nonce}`;
    const encoded=new TextEncoder().encode(message);
    const{signature}=await provider.signMessage(encoded,'utf8');
    const sig58=toBase58(signature);
    const{token}=await api('/api/auth/verify',{method:'POST',body:JSON.stringify({wallet:walletAddr,signature:sig58,nonce})});
    jwt=token;
    localStorage.setItem('shieldfi_jwt',jwt);
    localStorage.setItem('shieldfi_wallet',walletAddr);
    await api('/api/wallets',{method:'POST',body:JSON.stringify({address:walletAddr})});
    showConnected();
    // Auto-populate scan input and run full wallet lookup
    $('lookupAddr').value = walletAddr;
    lookupWallet();
    toast('Wallet connected!','success');
  }catch(e){
    console.error(e);showError(e.message||'Connection failed');
    $('connectBtn').disabled=false;$('connectBtn').textContent='Connect Wallet';
  }
}

function showConnected(){
  const wd=$('walletDisplay');
  wd.textContent='üü¢ '+short(walletAddr);
  wd.dataset.full=walletAddr;
  wd.style.display='inline-block';
  $('connectBtn').style.display='none';
  $('disconnectBtn').style.display='inline-flex';
  $('scanBtn').style.display='inline-flex';
}

function disconnect(){
  // Clear local state
  localStorage.removeItem('shieldfi_jwt');
  localStorage.removeItem('shieldfi_wallet');
  jwt=null;walletAddr=null;
  // Try disconnecting Phantom
  try{(window.phantom?.solana||window.solana)?.disconnect()}catch{}
  // Reset UI
  $('walletDisplay').style.display='none';
  $('connectBtn').style.display='inline-flex';
  $('connectBtn').textContent='Connect Wallet';
  $('connectBtn').disabled=false;
  $('scanBtn').style.display='none';
  $('disconnectBtn').style.display='none';
  $('cards').style.display='none';
  $('monitorSection').style.display='none';
  $('riskAnalysis').style.display='none';
  $('content').innerHTML='<div class="empty-state"><div class="empty-icon">üîå</div><p>Connect your Phantom wallet or paste any Solana address above to scan</p></div>';
  toast('Wallet disconnected','info');
}

async function scan(){
  $('scanBtn').disabled=true;$('scanBtn').textContent='‚è≥ Scanning‚Ä¶';
  showSkeleton();
  try{
    const data=await api('/api/approvals/scan',{method:'POST',body:'{}'});
    renderApprovals(data.approvals||[],data.walletScore||0);
  }catch(e){
    showError('Scan failed: '+e.message);
    $('content').innerHTML='<div class="empty-state"><div class="empty-icon">‚ö†Ô∏è</div><p>Scan failed. Try again.</p></div>';
  }finally{$('scanBtn').disabled=false;$('scanBtn').textContent='üîç Scan'}
}

async function loadApprovals(){
  try{const data=await api('/api/approvals');renderApprovals(data.approvals||[],data.walletScore||0)}catch(e){showError(e.message)}
}

function renderApprovals(approvals,score){
  setRiskLevel(approvals.length?null:'SAFE');
  setTokenStats([]);
  if(!approvals.length){
    $('content').innerHTML='<div class="empty-state"><div class="empty-icon">‚úÖ</div><p>No active approvals found. Your wallet looks clean!</p></div>';
    return;
  }
  const riskOrder={CRITICAL:4,HIGH:3,MEDIUM:2,LOW:1};

  let html='<div class="section"><div class="section-title">Active Approvals</div>';
  for(const a of approvals){
    const tokenLabel=a.tokenSymbol||short(a.tokenMint);
    html+=`<div class="approval-card">
      <div class="approval-header">
        <div style="display:flex;align-items:center;gap:.5rem">
          ${a.tokenIcon?`<img src="${a.tokenIcon}" width="24" height="24" style="border-radius:50%" onerror="this.style.display='none'">`:''}
          <strong>${tokenLabel}</strong>
          <span class="badge badge-${a.riskLevel}">${a.riskLevel}</span>
        </div>
        <button class="btn btn-revoke" onclick="revoke('${a.id}')">Revoke</button>
      </div>
      <div class="approval-detail">
        <span>Spender: ${copyable(a.spender)}</span>
        <span>Amount: ${a.isUnlimited?'<span style="color:#ff6644">‚ôæÔ∏è Unlimited</span>':a.amount}</span>
      </div>
    </div>`;
  }
  html+='</div>';
  $('content').innerHTML=html;
}

async function revoke(id){
  const provider=getProvider();if(!provider)return;
  try{
    const data=await api(`/api/approvals/${id}/revoke`,{method:'POST'});
    const{Transaction}=await import('https://esm.sh/@solana/web3.js@1.95.0');
    const txBuf=Uint8Array.from(atob(data.transaction),c=>c.charCodeAt(0));
    const tx=Transaction.from(txBuf);
    const signed=await provider.signTransaction(tx);
    const{Connection}=await import('https://esm.sh/@solana/web3.js@1.95.0');
    const conn=new Connection('https://api.mainnet-beta.solana.com','confirmed');
    const sig=await conn.sendRawTransaction(signed.serialize());
    toast('Revoke submitted! TX: '+short(sig),'success');
    scan();
  }catch(e){console.error(e);showError('Revoke failed: '+e.message)}
}

/* ---- Lookup ---- */
let currentLookupAddr=null;
let lastLookupAddr=null;
let hasUnknownOrSuspicious=false;

async function lookupWallet(){
  const addr=$('lookupAddr').value.trim();
  if(!addr)return showError('Paste a Solana address first');
  currentLookupAddr=addr;lastLookupAddr=addr;
  showSkeleton();
  $('lookupBtn').disabled=true;$('lookupBtn').textContent='‚è≥ Scanning‚Ä¶';

  try{
    const res=await fetch(`/api/approvals/lookup?address=${encodeURIComponent(addr)}`);
    if(!res.ok){const e=await res.json();throw new Error(e.error||'Lookup failed')}
    const data=await res.json();
    renderLookup(data);
    $('monitorSection').style.display='block';
    $('riskAnalysis').style.display='block';
    checkMonitorStatus(addr);
    // Always auto-trigger risk analysis on scan
    setTimeout(()=>runRiskAnalysis(),300);
  }catch(e){
    showError(e.message);
    $('content').innerHTML='<div class="empty-state"><div class="empty-icon">‚ö†Ô∏è</div><p>Lookup failed. Check the address.</p></div>';
  }finally{$('lookupBtn').disabled=false;$('lookupBtn').textContent='Scan'}
}

function renderLookup(data){
  setTokenStats(data.balances||[]);
  hasUnknownOrSuspicious=false;
  let html='';

  // Token balances
  if(data.balances&&data.balances.length>0){
    const verified=data.balances.filter(b=>b.status==='verified');
    const unknown=data.balances.filter(b=>b.status==='unknown');
    const suspicious=data.balances.filter(b=>b.status==='suspicious');
    if(unknown.length||suspicious.length)hasUnknownOrSuspicious=true;

    // SOL hero
    const sol=data.balances.find(b=>b.symbol==='SOL');
    if(sol){
      html+=`<div class="sol-hero">
        <div class="label">SOL Balance</div>
        <div class="amount">${fmt(sol.balance,4)} SOL</div>
        ${sol.usdValue?`<div class="usd">${fmtUsd(sol.usdValue)}</div>`:''}
      </div>`;
    }

    // Verified tokens
    if(verified.length>0){
      const totalUsd=verified.reduce((s,b)=>s+(b.usdValue||0),0);
      html+=`<div class="section" id="sectionVerified"><div class="section-title">‚úÖ Verified Tokens <span style="color:#00d4aa;font-size:.8rem;font-weight:400;text-transform:none;letter-spacing:0">‚Äî ${fmtUsd(totalUsd)} total</span></div><div class="token-grid">`;
      for(const b of verified){
        if(b.symbol==='SOL')continue;
        html+=tokenCard(b,true);
      }
      html+='</div></div>';
    }

    if(unknown.length>0){
      html+=`<div class="section" id="sectionUnknown"><div class="section-title">‚ùì Unknown Tokens (${unknown.length})</div><div class="token-grid">`;
      for(const b of unknown)html+=tokenCard(b,false);
      html+='</div></div>';
    }

    if(suspicious.length>0){
      html+=`<div class="section" id="sectionSuspicious"><div class="section-title" style="color:#ff6644">‚ö†Ô∏è Suspicious Tokens (${suspicious.length})</div>
        <div style="font-size:.8rem;color:#555;margin-bottom:.75rem">These tokens may be scam airdrops. Do not interact with them.</div>
        <div class="token-grid">`;
      for(const b of suspicious)html+=tokenCard(b,false);
      html+='</div></div>';
    }
  }

  // Approvals
  if(data.approvals.length>0){
    const riskOrder={CRITICAL:4,HIGH:3,MEDIUM:2,LOW:1};
    const worst=data.approvals.reduce((a,b)=>(riskOrder[b.riskLevel]||0)>(riskOrder[a.riskLevel]||0)?b:a);
    html+='<div class="section"><div class="section-title">üîì Active Approvals</div>';
    for(const a of data.approvals){
      html+=`<div class="approval-card">
        <div class="approval-header">
          <div style="display:flex;align-items:center;gap:.5rem">
            ${a.tokenIcon?`<img src="${a.tokenIcon}" width="24" height="24" style="border-radius:50%" onerror="this.style.display='none'">`:''}
            <strong>${a.tokenSymbol||short(a.tokenMint)}</strong>
            <span class="badge badge-${a.riskLevel}">${a.riskLevel}</span>
          </div>
        </div>
        <div class="approval-detail">
          <span>Spender: ${copyable(a.spender)}</span>
          <span>Amount: ${a.isUnlimited?'<span style="color:#ff6644">‚ôæÔ∏è Unlimited</span>':a.amount}</span>
        </div>
      </div>`;
    }
    html+='</div>';
  }else{
    if(!data.balances?.length){
      html='<div class="empty-state"><div class="empty-icon">üì≠</div><p>No tokens or approvals found. Wallet may be empty.</p></div>';
    }
  }

  $('content').innerHTML=html;

  // Auto-load transactions
  if(currentLookupAddr)loadTransactions(currentLookupAddr);
}

function tokenCard(b,showUsd){
  const icon=b.icon?`<img src="${b.icon}" onerror="this.parentNode.innerHTML='üíé'">`:'üíé';
  const solscanUrl=b.mint&&b.mint!=='native'?`https://solscan.io/token/${b.mint}`:'https://solscan.io/token/So11111111111111111111111111111111111111112';
  return `<a href="${solscanUrl}" target="_blank" rel="noopener" class="token-item" style="text-decoration:none;color:inherit">
    <div class="token-icon">${icon}</div>
    <div class="token-info">
      <div class="token-symbol">${b.symbol}${b.flags&&b.flags.length?` <span style="font-size:.7rem;color:#ff6644" title="${b.flags.join(', ')}">‚ö†</span>`:''}</div>
      <div class="token-balance">${fmt(b.balance,4)}</div>
    </div>
    ${showUsd&&b.usdValue?`<div class="token-usd">${fmtUsd(b.usdValue)}</div>`:''}
  </a>`;
}

/* ---- Transactions ---- */
const TX_TYPE_COLORS={SWAP:'#7b61ff',TRANSFER:'#00d4aa',NFT_SALE:'#ff6644',NFT_MINT:'#ffaa00',NFT_LISTING:'#ff8844',BURN:'#ff4444',STAKE:'#44aaff',UNSTAKE:'#4488ff',COMPRESSED_NFT_MINT:'#ffaa00',TOKEN_MINT:'#44ddaa',UNKNOWN:'#555'};

async function loadTransactions(addr){
  const container=document.createElement('div');
  container.className='section';
  container.innerHTML=`<div class="section-title">üìú Recent Activity</div>
    <div class="skeleton" style="height:56px;margin-bottom:.5rem"></div>
    <div class="skeleton" style="height:56px;margin-bottom:.5rem"></div>
    <div class="skeleton" style="height:56px"></div>`;
  $('content').appendChild(container);

  try{
    const res=await fetch(`/api/transactions/${encodeURIComponent(addr)}?limit=20`);
    if(!res.ok)throw new Error('Failed');
    const data=await res.json();
    const txs=data.transactions||[];

    if(!txs.length){
      container.innerHTML='<div class="section-title">üìú Recent Activity</div><div style="color:#444;text-align:center;padding:1.5rem">No recent transactions found.</div>';
      return;
    }

    let html=collapsibleTitle('üìú Recent Activity',` (${txs.length})`);
    for(const tx of txs){
      const type=tx.type||'UNKNOWN';
      const color=TX_TYPE_COLORS[type]||TX_TYPE_COLORS.UNKNOWN;
      const time=tx.timestamp?new Date(tx.timestamp*1000).toLocaleString():'‚Äî';
      const desc=tx.description||'';
      const sig=tx.signature||'';

      let transfers='';
      if(tx.tokenTransfers&&tx.tokenTransfers.length>0){
        transfers=tx.tokenTransfers.slice(0,3).map(t=>{
          const amt=t.tokenAmount!=null?fmt(parseFloat(t.tokenAmount),4):'?';
          const sym=t.mint?t.mint.slice(0,4)+'‚Ä¶':'';
          return `${amt} ${sym}`;
        }).join(' ¬∑ ');
      }
      if(tx.nativeTransfers&&tx.nativeTransfers.length>0&&!transfers){
        const total=tx.nativeTransfers.reduce((s,t)=>s+Math.abs(t.amount||0),0)/1e9;
        if(total>0)transfers=`${fmt(total,4)} SOL`;
      }

      html+=`<div class="tx-item" style="border-left-color:${color}">
        <div class="tx-header">
          <div><span class="badge" style="background:${color}18;color:${color}">${type}</span></div>
          <span class="tx-time">${time}</span>
        </div>
        ${desc?`<div class="tx-desc">${desc.length>120?desc.slice(0,120)+'‚Ä¶':desc}</div>`:''}
        ${transfers?`<div class="tx-transfers">${transfers}</div>`:''}
        ${sig?`<a href="https://solscan.io/tx/${sig}" target="_blank" class="tx-link">View on Solscan ‚Üí</a>`:''}
      </div>`;
    }
    html+='</div>'; // close collapsible
    container.innerHTML=html;
  }catch{
    container.innerHTML='<div class="section-title">üìú Recent Activity</div><div style="color:#444;text-align:center;padding:1.5rem">Failed to load transactions.</div>';
  }
}

/* ---- Monitoring ---- */
async function checkMonitorStatus(addr){
  try{
    const res=await fetch(`/api/monitor/${encodeURIComponent(addr)}/status`);
    const data=await res.json();
    if(data.isMonitored){
      $('monitorBtn').textContent='üî¥ Stop Monitoring';
      $('monitorBtn').onclick=()=>stopMonitor(addr);
      $('monitorStatus').innerHTML='<span style="color:#00d4aa">üü¢ Active</span>'+(data.lastCheckedAt?' ‚Äî last: '+new Date(data.lastCheckedAt).toLocaleTimeString():'');
      loadMonitorAlerts(addr);
      // Show Telegram link section
      $('telegramLink').style.display='block';
      if(data.telegramLinked){
        $('telegramStatus').innerHTML='‚úÖ <span style="color:#00d4aa">Telegram connected</span>';
        $('telegramBtn').textContent='üîì Unlink Telegram';
        $('telegramBtn').onclick=()=>unlinkTelegram(addr);
      }else{
        $('telegramStatus').innerHTML='üì≠ <span style="color:#888">No Telegram linked ‚Äî alerts won\'t be sent</span>';
        $('telegramBtn').textContent='üì± Connect Telegram';
        $('telegramBtn').onclick=()=>linkTelegram(addr);
      }
    }else{
      $('monitorBtn').textContent='üîî Start Monitoring';
      $('monitorBtn').onclick=()=>startMonitor(addr);
      $('monitorStatus').textContent='';$('monitorAlerts').innerHTML='';
      $('telegramLink').style.display='none';
    }
  }catch{}
}

async function startMonitor(addr){
  try{$('monitorBtn').disabled=true;
    const res=await fetch('/api/monitor/add',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({address:addr})});
    if(!res.ok)throw new Error('Failed');
    toast('Monitoring started!','success');checkMonitorStatus(addr);
  }catch(e){showError('Failed to start monitoring: '+e.message)}
  finally{$('monitorBtn').disabled=false}
}

async function stopMonitor(addr){
  try{$('monitorBtn').disabled=true;
    await fetch(`/api/monitor/${encodeURIComponent(addr)}`,{method:'DELETE'});
    toast('Monitoring stopped','info');checkMonitorStatus(addr);
  }catch(e){showError('Failed to stop monitoring: '+e.message)}
  finally{$('monitorBtn').disabled=false}
}

async function loadMonitorAlerts(addr){
  try{
    const res=await fetch(`/api/monitor/${encodeURIComponent(addr)}/alerts`);
    const data=await res.json();const alerts=data.alerts||[];
    if(!alerts.length){$('monitorAlerts').innerHTML='<div style="color:#444;font-size:.85rem;text-align:center;padding:.75rem">No alerts yet ‚Äî monitoring active</div>';return}
    let html='<div class="section-title" style="margin-top:.5rem">Recent Alerts</div>';
    for(const a of alerts.slice(0,10)){
      const sevColor=a.severity==='CRITICAL'?'#ff0044':a.severity==='WARNING'?'#ffaa00':'#00d4aa';
      const emoji=a.severity==='CRITICAL'?'üö®':a.severity==='WARNING'?'‚ö†Ô∏è':'‚ÑπÔ∏è';
      html+=`<div class="tx-item" style="border-left-color:${sevColor}">
        <div class="tx-header"><span>${emoji} <strong style="color:${sevColor}">${a.severity}</strong> ‚Äî ${a.title}</span><span class="tx-time">${new Date(a.createdAt).toLocaleString()}</span></div>
        <div class="tx-desc">${a.message}</div>
        ${a.txSignature?`<a href="https://solscan.io/tx/${a.txSignature}" target="_blank" class="tx-link">View on Solscan ‚Üí</a>`:''}
      </div>`;
    }
    $('monitorAlerts').innerHTML=html;
  }catch{}
}

async function linkTelegram(addr){
  try{
    const res=await fetch('/api/monitor/telegram/link',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({address:addr})});
    const data=await res.json();
    if(data.alreadyLinked){toast('Telegram already connected!','success');checkMonitorStatus(addr);return}
    if(data.deepLink){
      window.open(data.deepLink,'_blank');
      toast('Opening Telegram bot ‚Äî click Start to connect','info');
      // Poll for completion
      let checks=0;
      const poll=setInterval(async()=>{
        checks++;
        if(checks>30){clearInterval(poll);return}
        const r=await fetch(`/api/monitor/${encodeURIComponent(addr)}/status`);
        const s=await r.json();
        if(s.telegramLinked){clearInterval(poll);toast('Telegram connected!','success');checkMonitorStatus(addr)}
      },3000);
    }
  }catch(e){showError('Failed to generate link: '+e.message)}
}

async function unlinkTelegram(addr){
  try{
    await fetch('/api/monitor/telegram/unlink',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({address:addr})});
    toast('Telegram unlinked','info');checkMonitorStatus(addr);
  }catch(e){showError('Failed to unlink: '+e.message)}
}

function toggleMonitor(){if(currentLookupAddr)startMonitor(currentLookupAddr)}

/* ---- Risk Analysis ---- */
async function runRiskAnalysis(){
  const addr=lastLookupAddr||$('lookupAddr').value.trim();
  if(!addr)return showError('No wallet address to analyze');
  const btn=$('riskAnalysisBtn');
  btn.disabled=true;btn.textContent='‚è≥ Analyzing tokens & contracts‚Ä¶';
  $('riskAnalysisStatus').textContent='This may take 10-20 seconds‚Ä¶';
  $('riskSummary').style.display='none';$('tokenReports').innerHTML='';

  try{
    const res=await fetch(`/api/risk/wallet?address=${encodeURIComponent(addr)}`);
    if(!res.ok){const e=await res.json();throw new Error(e.error||'Analysis failed')}
    renderRiskAnalysis(await res.json());
    toast('Risk analysis complete','success');
  }catch(e){showError('Risk analysis failed: '+e.message)}
  finally{btn.disabled=false;btn.textContent='üî¨ Run Deep Analysis';$('riskAnalysisStatus').textContent=''}
}

function renderRiskAnalysis(data){
  setRiskLevel(data.level);
  const summaryEl=$('riskSummary');summaryEl.style.display='block';
  const levelColors={SAFE:'#00d4aa',LOW:'#00d4aa',MEDIUM:'#ffaa00',HIGH:'#ff6644',CRITICAL:'#ff0044'};
  const levelEmoji={SAFE:'‚úÖ',LOW:'üü¢',MEDIUM:'üü°',HIGH:'üü†',CRITICAL:'üî¥'};
  const color=levelColors[data.level]||'#888';

  $('riskSummaryText').innerHTML=`
    <div style="display:flex;align-items:center;gap:.75rem;margin-bottom:.75rem">
      <span style="font-size:1.8rem">${levelEmoji[data.level]||'‚ùì'}</span>
      <div><div style="font-size:1.2rem;font-weight:700;color:${color}">Risk Level: ${data.level}</div>
      <div style="font-size:.85rem;color:#666">Score: ${data.overallScore}/100 (lower is safer)</div></div>
    </div>
    <div style="color:#bbb;font-size:.9rem;line-height:1.6">${data.summary}</div>`;

  const reports=data.tokenReports||[];
  if(!reports.length){$('tokenReports').innerHTML='<div style="color:#444;text-align:center;padding:1rem">No unknown/suspicious tokens to analyze.</div>';return}

  let html=collapsibleTitle('Token Risk Reports',` (${reports.length})`);
  for(const r of reports){
    const c=levelColors[r.level]||'#888';
    const flagsHtml=r.flags.map(f=>{
      const sc=f.severity==='danger'?'#ff4444':f.severity==='warning'?'#ffaa00':'#555';
      return `<div style="display:flex;align-items:center;gap:.5rem;padding:3px 0;font-size:.85rem"><span>${f.severity==='danger'?'üî¥':f.severity==='warning'?'üü°':'‚ÑπÔ∏è'}</span><span style="color:#aaa">${f.signal}</span><span style="color:${sc};font-size:.75rem;margin-left:auto">${f.category}</span></div>`;
    }).join('');

    html+=`<div style="padding:1rem;background:#0a0a0a;border:1px solid #151520;border-left:3px solid ${c};border-radius:10px;margin-bottom:.5rem">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:.5rem">
        <strong>${r.symbol||short(r.mint)}</strong>
        <span class="badge" style="background:${c}18;color:${c}">${r.level} (${r.overallScore})</span>
      </div>
      <div style="font-family:monospace;font-size:.75rem;color:#444;margin-bottom:.5rem"><a href="https://solscan.io/token/${r.mint}" target="_blank" style="color:#7b61ff">${r.mint.slice(0,8)}‚Ä¶${r.mint.slice(-4)}</a></div>
      ${r.metadata?.mintAuthority?`<div style="font-size:.8rem;color:#ff6644;margin-bottom:4px">‚ö†Ô∏è Mint authority: ${r.metadata.mintAuthority.slice(0,8)}‚Ä¶</div>`:''}
      ${r.metadata?.freezeAuthority?`<div style="font-size:.8rem;color:#ffaa00;margin-bottom:4px">‚ùÑÔ∏è Freeze authority: ${r.metadata.freezeAuthority.slice(0,8)}‚Ä¶</div>`:''}
      ${flagsHtml}
    </div>`;
  }

  html+='</div>'; // close token reports collapsible
  const spenderRisks=data.approvalRisks||[];
  if(spenderRisks.length>0){
    html+=collapsibleTitle('Spender Analysis',` (${spenderRisks.length})`);
    for(const s of spenderRisks){
      const sColor=s.isKnown?'#00d4aa':s.riskScore>20?'#ff6644':'#ffaa00';
      html+=`<div style="padding:.75rem;background:#0a0a0a;border:1px solid #151520;border-left:3px solid ${sColor};border-radius:10px;margin-bottom:.5rem">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <span style="font-family:monospace;font-size:.85rem"><a href="https://solscan.io/account/${s.spender}" target="_blank" style="color:#7b61ff">${s.spender.slice(0,8)}‚Ä¶${s.spender.slice(-4)}</a></span>
          <span style="font-size:.85rem;color:${sColor}">${s.isKnown?'‚úÖ Known DeFi':s.label||'Unknown'}</span>
        </div>
        ${s.flags.map(f=>`<div style="font-size:.8rem;color:#666;margin-top:4px">${f.severity==='danger'?'üî¥':'üü°'} ${f.signal}</div>`).join('')}
      </div>`;
    }
    html+='</div>'; // close spender collapsible
  }
  $('tokenReports').innerHTML=html;
}

/* ---- URL param auto-scan ---- */
const urlParams=new URLSearchParams(window.location.search);
const autoAddr=urlParams.get('address');
if(autoAddr){
  $('lookupAddr').value=autoAddr;
  window.addEventListener('DOMContentLoaded',()=>setTimeout(lookupWallet,100));
  // If DOM already loaded
  if(document.readyState!=='loading')setTimeout(lookupWallet,100);
}

/* Enter key on scan input */
$('lookupAddr').addEventListener('keydown',e=>{if(e.key==='Enter')lookupWallet()});

/* Auto-restore session */
if(jwt&&walletAddr){
  fetch('/api/approvals',{headers:{'Authorization':'Bearer '+jwt}})
    .then(r=>{if(r.ok){showConnected();if(!autoAddr){$('lookupAddr').value=walletAddr;lookupWallet()}}else throw 0})
    .catch(()=>{localStorage.removeItem('shieldfi_jwt');localStorage.removeItem('shieldfi_wallet');jwt=null;walletAddr=null});
}
</script>
</body>
</html>
